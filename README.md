# Увеличение в реальном времени при движении
Приложение в реальном времени на базе OpenCV / Qt для увеличения видео по Эйлеру. Работает с несколькими видео и камерами одновременно и позволяет экспортировать увеличенные видео.

## Примеры
![Видео с цветным увеличением](pictures/j_color-vid.png)

*Изображение показывает видео с цветным увеличением. На изображениях вы можете увидеть влияние сердечного цикла на цвет кожи. На верхнем изображении показана кожа лица во время диастолы, на нижнем - во время систолы желудочков цикла.*



![Поток увеличенной в движении камеры](изображения/j_motion-cam.png)

* (Не) нужные артефакты из видеопотока, увеличенного камерой в режиме реального времени. Четкие черно-белые области вокруг туловища и головы являются результатом быстрого движения назад и чрезмерного усиления. Белые точки (те, что больше шума) с левой стороны - это закрученные частицы пыли, не видимые в исходном источнике камеры.*

### Зависимости
- [Qt](http://qt-project.org/) >= 5.0
- [OpenCV](http://opencv.org/) >= 2.0 (< 3.0 ? -> еще не протестирован)

### Лицензия
Это приложение лицензировано под GPLv3, ознакомьтесь с [ЛИЦЕНЗИЕЙ](ЛИЦЕНЗИЯ).

### Кредиты
Спасибо Нику Д'Адемо, чье приложение [qt-opencv-многопоточный](https://github.com/nickdademo/qt-opencv-multithreaded)
послужило основой, и Джозефу Пэну, чьи алгоритмы в приложении [QtEVM](https://github.com/wzpan/QtEVM) были адаптированы
для этого проекта.

Также загляните на веб-страницу MITs для [увеличения видео по Эйлеру](http://people.csail.mit.edu/mrub/vidmag/).
Они предоставляют демонстрационные видеоролики на своей странице, и команда проделала фантастическую работу по исследованию и развитию этой области науки.

# Как мне это использовать?
### Подключите
- Камера
- Номер устройства: Введите номер устройства вашей камеры, подключенной к компьютеру. Индексация начинается с 0, который обычно соответствует вашей встроенной веб-камере.
- (Ubuntu/Linux) Подключите устройство Grey к USB: При подключении камеры DC1394 к вашему компьютеру OpenCV перенаправляет камеру через v4l-API на устройство с номером 0. Если вы хотите также подключиться к вашей встроенной камере, включите эту опцию, чтобы установить значение встроенной камеры равным 0, DC1394 - 1
- Буфер изображений: Выберите длину буфера изображений перед обработкой этих изображений. Если отключена функция удаления кадров при заполнении буфера, скорость захвата будет такой же, как и скорость обработки.
- Видео
- Выберите видео. Совместимость предоставляется, если ваш компьютер поддерживает кодек. Допустимыми окончаниями файлов являются .avi .mp4 .m4v .mkv .mov .wmv
- Разрешение: Это пока не работает для видео в Ubuntu/Linux (Windows не тестировалась). Для камер проверьте поддерживаемые режимы у производителя камеры и введите разрешение, указанное для режима.
- Кадров в секунду: Некоторые камеры поддерживают несколько режимов с разным разрешением / кадрами в секунду / и т.д. Установка частоты кадров приведет к переключению в режим с частотой кадров, близкой к той, которую вы ввели. Для видео некоторые mp4-файлы имеют неправильный заголовок, из-за которого OpenCV не может считывать частоту кадров, которая обычно устанавливается равной 30 кадрам в секунду. В любом случае здесь вы можете установить ее вручную.

![Диалог подключения](картинки/connect_dialog.png)

### Главное окно
После успешного подключения к камере или открытия окна вы можете нарисовать рамку на видео, чтобы масштабировать и усиливать только интересующую область в источнике видео. Вернуть видео в нормальное состояние можно с помощью меню, которое открывается при щелчке правой кнопкой мыши на видео. Также есть возможность показать не увеличенное изображение, помимо обработанного.

![Щелкните правой кнопкой мыши меню в метке кадра](pictures/frameLabel_menu.png)

### Увеличить
Попробуйте поэкспериментировать с различными значениями параметров. Кроме того, при наведении курсора на текстовую метку на вкладке параметры отображаются всплывающие подсказки. Если вы используете более старую машину и обработка выполняется слишком медленно, попробуйте включить флажок Оттенки серого.

| | Низкое значение *уровня* | Высокий *Уровень* ценности|
| :---------------------- | :-----------------: | :---------------: |
|**Цветовое увеличение ** | Медленнее и точнее. Слишком низкое значение = сигнал не обнаруживается | Более быстрое увеличение, неточное пространственное разрешение|
|** Увеличение движения **| Больше шума, меньше перемещений больших объектов | Меньше шума, меньше перемещений маленьких объектов |

#### Увеличение цвета
Обратите внимание, что в сцене для правильной обработки видео не требуется абсолютно никаких ДВИЖЕНИЙ.
- Усиление: Чем выше значение, тем более красочный и шумный результат.
- Частотный диапазон: Частота. диапазон периодически появляющихся изменений цвета, которые должны быть усилены.

![Панель для параметров увеличения цвета](pictures/cmag_options.png)

#### Увеличение движения
- Усиление: Чем выше значение, тем больше движений и шума усиливается.
- Длина волны среза: уменьшает быстрые движения и шум.
- Диапазон частот: Уменьшение значений обработчика приводит к увеличению медленных движений больше, чем быстрых, и наоборот.
- Ослабление цветности: Чем выше значение, тем больше усиливаются каналы цветности, например, тем более красочными становятся движения.

![Панель параметров увеличения движения](pictures/lmag_options.png)

### Сохранить
Для сохранения видео или записи с камеры вам необходимо самостоятельно указать расширение файла. .avi хорошо поддерживается. Если у вас возникнут проблемы, пожалуйста, попробуйте другой кодек сохранения на панели инструментов в разделе Файл->Установить кодек сохранения.

![Главное окно с сохранением меню кодеков](pictures/mainWindow_Codecs.png)

# Как это работает?
На рисунке ниже представлена структура классов и поток данных (синий = изображения, красный = параметры) во всем приложении.

![Структура класса](картинки/class_structure.png)


### Алгоритм
Алгоритмы используют комбинацию пространственных фильтров (например, пирамиды изображений) и временных фильтров для определения
движений с различной пространственной длиной волны в видео. Они могут быть усилены отдельно перед сворачиванием пирамиды изображений
и добавлением движущегося изображения обратно к оригиналу.

![Идея алгоритма увеличения видео](pictures/magnification.png)

#### Цветовое увеличение
Для получения дополнительной информации смотрите комментарии в .h/.cpp файлы в /main/magnification/*

![Цветовое увеличение UML](pictures/colorMag.png)

#### Увеличение движения
Для получения дополнительной информации ознакомьтесь с комментариями в .h/.cpp файлы в /main/magnification/*

![Увеличение Лапласа UML](pictures/motionMag.png)
